# 题面原生渲染功能说明

## 📱 功能概述

实现了一个**移动端友好的原生题面渲染系统**，可以后台下载 Codeforces 题目数据，然后在应用内用原生 SwiftUI 重新渲染，无需依赖 WebView 加载完整网页。

## ✨ 核心特性

### 1. 双模式查看
- **原生渲染模式**：美观、快速、可定制
- **网页模式**：保留原始 Codeforces 页面（兼容方案）
- 一键切换，用户偏好自动保存

### 2. 移动端优化界面
- ✅ 大字体、高对比度，易于阅读
- ✅ 卡片式样例展示，可一键复制
- ✅ 支持 LaTeX 公式渲染（MathJax）
- ✅ 响应式图片加载（自动处理 Codeforces 相对路径）
- ✅ 字体大小可调节（小/中/大/特大）
- ✅ 自动适配深色模式
- ✅ 文本可选择复制
- ✅ 智能段落提取（避免重复内容）

### 3. 智能缓存系统
- 自动缓存已查看的题目
- 离线可查看缓存内容
- 7天自动过期机制
- 支持手动刷新

### 4. 数据提取稳定
- 直接用 URLSession 抓取 HTML（无需登录）
- 纯 Swift 正则解析（不依赖第三方库）
- 自动识别 Cloudflare 拦截
- 失败时自动回退到网页模式

## 📂 新增文件

```
CfEditor/contests/
├── ProblemStatement.swift         # 数据模型
├── ProblemParser.swift            # HTML 解析器
├── ProblemCache.swift             # 缓存管理
├── ProblemStatementView.swift     # 原生渲染视图
└── ProblemViewerWrapper.swift     # 双模式包装器
```

## 🎨 界面设计

### 标题区域
```
┌─────────────────────────────┐
│  A. Problem Title           │  ← 大标题
│  ⏱ 1s  💾 256MB             │  ← 限制信息
│  ↓ standard input           │  ← IO 信息
│  ↑ standard output          │
└─────────────────────────────┘
```

### 样例卡片
```
┌───── 样例 1 ──────┐
│ [复制输入] 按钮     │
├──────────────────┤
│ 输入              │
│ 3                │  ← 等宽字体
│ 1 2 3            │  ← 可复制
├──────────────────┤
│ 输出              │
│ 6                │
└──────────────────┘
```

## 🔧 使用方法

### 用户操作
1. 点击任意题目，自动进入原生渲染模式
2. 点击右上角图标切换查看模式
3. 点击 "复制输入" 按钮复制样例数据
4. 点击右上角字体图标调整字号

### 开发者配置

#### 1. 切换默认模式
用户偏好会自动保存在 UserDefaults：
\`\`\`swift
@AppStorage("preferNativeRenderer") private var preferNativeRenderer: Bool = true
\`\`\`

#### 2. 清空缓存
\`\`\`swift
await ProblemCache.shared.clearAll()
\`\`\`

#### 3. 查看缓存统计
\`\`\`swift
let stats = ProblemCache.shared.getStats()
print("缓存题目数: \\(stats.totalProblems)")
print("缓存大小: \\(stats.totalSize) bytes")
\`\`\`

## 🚀 技术实现

### 数据流程
```
用户点击题目
    ↓
检查缓存
    ↓
    ├─ 有缓存 → 直接显示
    └─ 无缓存 → URLSession 下载 HTML
              ↓
           正则解析提取数据
              ↓
           保存到本地缓存
              ↓
           SwiftUI 原生渲染
```

### HTML 解析
使用纯 Swift 正则表达式提取：
- 标题、时间限制、内存限制
- 题面描述（支持 LaTeX、图片、列表）
- 输入/输出格式
- 样例数据（输入/输出对）
- 注释说明

### LaTeX 渲染
使用轻量级 WKWebView + MathJax CDN：
- 动态计算公式高度
- 自适应深色模式
- 支持行内和块级公式

## 🎯 优势对比

| 特性 | 原生渲染 | WebView |
|------|---------|---------|
| 加载速度 | ⚡️ 极快 | 🐢 较慢 |
| 字体调节 | ✅ 真正原生 | ❌ 只能缩放 |
| 样例复制 | ✅ 一键复制 | ❌ 需手动选择 |
| 离线查看 | ✅ 支持 | ❌ 不支持 |
| 流量消耗 | 💾 极低 | 📶 较高 |
| 自定义能力 | ✅ 完全可控 | ❌ 受限于网页 |

## 🐛 错误处理

### Cloudflare 拦截
- 自动识别验证页面
- 提示用户切换到网页模式
- 网页模式继承已有 Cookie

### 网络错误
- 显示友好错误提示
- 提供重试按钮
- 提供切换到网页模式选项

### 解析失败
- 保留原始 HTML
- 自动回退到网页模式
- 记录错误日志供调试

## 📊 性能优化

1. **懒加载**：只在用户切换到原生模式时才下载数据
2. **智能缓存**：7天内不重复下载
3. **异步处理**：所有网络和解析操作异步执行
4. **内存优化**：使用 Codable 序列化，减少内存占用

## 🔮 未来扩展

可以轻松添加的功能：
- [ ] 题目收藏/标注
- [ ] 本地笔记
- [ ] 题解链接
- [ ] 相似题目推荐
- [ ] 题目难度可视化
- [ ] 导出为 PDF/Markdown
- [ ] 多语言翻译
- [ ] 语音朗读

## 💡 使用建议

1. **首次使用**：建议在 WiFi 环境下打开几道题目，建立缓存
2. **字号调节**：根据设备屏幕大小选择合适字号
3. **模式切换**：复杂公式较多时可切换到网页模式
4. **离线练习**：提前缓存比赛题目，比赛时可离线查看

## 🙏 技术栈

- **SwiftUI**：UI 框架
- **URLSession**：网络请求
- **NSRegularExpression**：HTML 解析
- **WKWebView**：LaTeX 渲染
- **Codable**：数据序列化
- **FileManager**：本地缓存

---

**开发完成时间**: 2025-10-09  
**版本**: 1.0.0  
**状态**: ✅ 已完成并集成

